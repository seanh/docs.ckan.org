<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Background Tasks &mdash; CKAN Documentation 2.1.5 documentation</title>
    
    <link rel="stylesheet" href="_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/css/bootstrap.css" type="text/css" />
    <link rel="stylesheet" href="_static/css/fix.css" type="text/css" />
    <link rel="stylesheet" href="_static/css/bootstrap-responsive.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="https://cdnmedia.readthedocs.org/css/badge_only.css" type="text/css" />
    <link rel="stylesheet" href="https://cdnmedia.readthedocs.org/css/readthedocs-doc-embed.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '2.1.5',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="https://cdnmedia.readthedocs.org/javascript/jquery/jquery-2.0.3.min.js"></script>
    <script type="text/javascript" src="https://cdnmedia.readthedocs.org/javascript/jquery/jquery-migrate-1.2.1.min.js"></script>
    <script type="text/javascript" src="https://cdnmedia.readthedocs.org/javascript/underscore.js"></script>
    <script type="text/javascript" src="https://cdnmedia.readthedocs.org/javascript/doctools.js"></script>
    <script type="text/javascript" src="https://cdnmedia.readthedocs.org/javascript/readthedocs-doc-embed.js"></script>
    <script type="text/javascript" src="_static/bootstrap-css-tweaks.js"></script>
    <link rel="top" title="CKAN Documentation 2.1.5 documentation" href="index.html" />
    <link rel="up" title="Features" href="features.html" />
    <link rel="next" title="Email Notifications" href="email-notifications.html" />
    <link rel="prev" title="Linked Data and RDF" href="linked-data-and-rdf.html" />


<!-- RTD Extra Head -->



  
  <!-- 
  Always link to the latest version, as canonical.
  http://docs.readthedocs.org/en/latest/canonical.html
  -->
  <link rel="canonical" href="http://docs.ckan.org//en/latest/background-tasks.html" />
  

<script type="text/javascript">
  // This is included here because other places don't have access to the pagename variable.
  var READTHEDOCS_DATA = {
    project: "ckan",
    version: "ckan-2.1.5",
    language: "en",
    page: "background-tasks",
    builder: "sphinx",
    theme: "sphinx-theme-okfn",
    docroot: "/doc/",
    source_suffix: ".rst",
    api_host: "https://readthedocs.org/",
    commit: "1d691ae3ba38a6b98dc69d0e2c16c71e186cd36e"
  }
  // Old variables
  var doc_version = "ckan-2.1.5";
  var doc_slug = "ckan";
  var page_name = "background-tasks";
  var html_theme = "sphinx-theme-okfn";
</script>
<!-- RTD Analytics Code -->
<!-- Included in the header because you don't have a footer block. -->
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-17997319-1']);
  _gaq.push(['_trackPageview']);


  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
<!-- end RTD Analytics Code -->
<!-- end RTD <extrahead> -->

  </head>
  <body role="document">
  
  <div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
      <div class="container-fluid">
        
        <a class="logo-icon pull-left" href="index.html"><img src="http://docs.ckan.org/en/ckan-2.1.5/_static/http://assets.okfn.org/p/opendatahandbook/img/data-wrench-inverted.png" alt="CKAN Documentation" /></a>
        
        <a class="brand" href="index.html">CKAN Documentation<span class="version"> v2.1.5</span></a>
        
        
        <a class="okfn-logo pull-right" href="http://okfn.org/" title="An Open Knowledge Foundation Project">
          <img src="https://s3.amazonaws.com/assets.okfn.org/p/okfn/img/logo_28x30.png" alt="Open Knowledge Foundation logo" />
        </a>
        
        
          
<form class="pull-right navbar-search" action="http://docs.ckan.org/en/ckan-2.1.5/search.html" method="get">
  <input type="text" name="q" placeholder="Search" class="search-query span2" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        
      </div>
    </div>
  </div>

<div class="container-fluid">
  <div class="row-fluid">
    <div class="span4">
      <div class="well sidebar-nav">
        
          
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h4>Previous topic</h4>
  <p class="topless"><a href="linked-data-and-rdf.html"
                        title="previous chapter">Linked Data and RDF</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="email-notifications.html"
                        title="next chapter">Email Notifications</a></p><div class="widget toc">
  <h3>Table of Contents</h3>
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installing.html">Installing CKAN</a></li>
<li class="toctree-l1"><a class="reference internal" href="upgrading.html">Upgrading CKAN</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting-started.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="features.html">Features</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="paster.html">Command Line Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="authorization.html">Authorization</a></li>
<li class="toctree-l2"><a class="reference internal" href="data-viewer.html">Data Viewer</a></li>
<li class="toctree-l2"><a class="reference internal" href="filestore.html">FileStore and File Uploads</a></li>
<li class="toctree-l2"><a class="reference internal" href="datastore.html">DataStore Extension</a></li>
<li class="toctree-l2"><a class="reference internal" href="apps-ideas.html">Apps &amp; Ideas</a></li>
<li class="toctree-l2"><a class="reference internal" href="tag-vocabularies.html">Tag Vocabularies</a></li>
<li class="toctree-l2"><a class="reference internal" href="form-integration.html">Form Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="linked-data-and-rdf.html">Linked Data and RDF</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="background-tasks.html">Background Tasks</a><ul>
<li class="toctree-l3"><a class="reference internal" href="background-tasks.html#enabling-background-tasks">Enabling Background Tasks</a></li>
<li class="toctree-l3"><a class="reference internal" href="background-tasks.html#writing-background-tasks">Writing Background Tasks</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="email-notifications.html">Email Notifications</a></li>
<li class="toctree-l2"><a class="reference internal" href="tracking.html">Page View Tracking</a></li>
<li class="toctree-l2"><a class="reference internal" href="multilingual.html">Multilingual Extension</a></li>
<li class="toctree-l2"><a class="reference internal" href="stats.html">Stats Extension</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="writing-extensions.html">Writing Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="theming.html">Theming</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">The CKAN API</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing to CKAN</a></li>
<li class="toctree-l1"><a class="reference internal" href="test.html">Testing CKAN</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Config File Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
</ul>

</div>

        </div>
      </div>
        
      </div><!--/.well -->
    </div><!--/span-->
    <div class="span8">
      <div class="content">

        
        <div style="font-size:smaller;">
              <a href="index.html">CKAN Documentation 2.1.5 documentation</a> &raquo;
              <a href="features.html"
                    accesskey="U">
                    Features
                  </a>
                   &raquo;
        </div>

        
  <div class="section" id="background-tasks">
<h1>Background Tasks<a class="headerlink" href="background-tasks.html#background-tasks" title="Permalink to this headline">¶</a></h1>
<p>CKAN allows you to create tasks that run in the &#8216;background&#8217;, that is
asynchronously and without blocking the main application (these tasks can also
be automatically retried in the case of transient failures). Such tasks can be
created in <a class="reference internal" href="writing-extensions.html"><em>Extensions</em></a> or in core CKAN.</p>
<p>Background tasks can be essential to providing certain kinds of functionality,
for example:</p>
<ul class="simple">
<li>Creating webhooks that notify other services when certain changes occur (for
example a dataset is updated)</li>
<li>Performing processing or validation or on data (as done by the Archiver and
DataStorer Extensions)</li>
</ul>
<div class="section" id="enabling-background-tasks">
<h2>Enabling Background Tasks<a class="headerlink" href="background-tasks.html#enabling-background-tasks" title="Permalink to this headline">¶</a></h2>
<p>To manage and run background tasks requires a job queue and CKAN uses <a class="reference external" href="http://celeryproject.org/">celery</a>
(plus the CKAN database) for this purpose. Thus, to use background tasks you
need to install and run <a class="reference external" href="http://celeryproject.org/">celery</a>.</p>
<p>Installation of <a class="reference external" href="http://celeryproject.org/">celery</a> will normally be taken care of by whichever component
or extension utilizes it so we skip that here.</p>
<p>To run the celery daemon you have two options:</p>
<ol class="arabic">
<li><p class="first">In development setup you can just use paster. This can be done as simply
as:</p>
<div class="highlight-python"><div class="highlight"><pre>paster celeryd
</pre></div>
</div>
<p>This only works if you have a <code class="docutils literal"><span class="pre">development.ini</span></code> file in ckan root.</p>
</li>
<li><p class="first">In production, the daemon should be run with a different ini file and be run
as an init script. The simplest way to do this is to install supervisor:</p>
<div class="highlight-python"><div class="highlight"><pre>apt-get install supervisor
</pre></div>
</div>
<p>Using this file as a template and copy to <code class="docutils literal"><span class="pre">/etc/supservisor/conf.d</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre>https://github.com/okfn/ckan/blob/master/ckan/config/celery-supervisor.conf
</pre></div>
</div>
<p>Alternatively, you can run:</p>
<div class="highlight-python"><div class="highlight"><pre>paster celeryd --config=/path/to/file.ini
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="writing-background-tasks">
<h2>Writing Background Tasks<a class="headerlink" href="background-tasks.html#writing-background-tasks" title="Permalink to this headline">¶</a></h2>
<p>These instructions should show you how to write an background task and how to
call it from inside CKAN or another extension using celery.</p>
<div class="section" id="examples">
<h3>Examples<a class="headerlink" href="background-tasks.html#examples" title="Permalink to this headline">¶</a></h3>
<p>Here are some existing real examples of writing CKAN tasks:</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/okfn/ckanext-archiver">https://github.com/okfn/ckanext-archiver</a></li>
<li><a class="reference external" href="https://github.com/okfn/ckanext-qa">https://github.com/okfn/ckanext-qa</a></li>
<li><a class="reference external" href="https://github.com/okfn/ckanext-datastorer">https://github.com/okfn/ckanext-datastorer</a></li>
</ul>
</div>
<div class="section" id="setup">
<h3>Setup<a class="headerlink" href="background-tasks.html#setup" title="Permalink to this headline">¶</a></h3>
<p>An entry point is required inside the <code class="docutils literal"><span class="pre">setup.py</span></code> for your extension, and so
you should add something resembling the following that points to a function in
a module. In this case the function is called task_imports in the
<code class="docutils literal"><span class="pre">ckanext.NAME.celery_import</span></code> module:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">entry_points</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">  [ckan.celery_task]</span>
<span class="s">  tasks = ckanext.NAME.celery_import:task_imports</span>
<span class="s">&quot;&quot;&quot;</span>
</pre></div>
</div>
<p>The function, in this case <code class="docutils literal"><span class="pre">task_imports</span></code> should be a function that returns
fully qualified module paths to modules that contain the defined task (see the
next section).  In this case we will put all of our tasks in a file called
<code class="docutils literal"><span class="pre">tasks.py</span></code> and so <code class="docutils literal"><span class="pre">task_imports</span></code> should be in a file called
<code class="docutils literal"><span class="pre">ckanext/NAME/celery_import.py</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">task_imports</span><span class="p">():</span>
  <span class="k">return</span> <span class="p">[</span><span class="s">&#39;ckanext.NAME.tasks&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>This returns an iterable of all of the places to look to find tasks, in this
example we are only putting them in one place.</p>
</div>
<div class="section" id="implementing-the-tasks">
<h3>Implementing the tasks<a class="headerlink" href="background-tasks.html#implementing-the-tasks" title="Permalink to this headline">¶</a></h3>
<p>The most straightforward way of defining tasks in our <code class="docutils literal"><span class="pre">tasks.py</span></code> module, is
to use the decorators provided by celery. These decorators make it easy to just
define a function and then give it a name and make it accessible to celery.
Make sure you import celery from ckan.lib.celery_app:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">ckan.lib.celery_app</span> <span class="kn">import</span> <span class="n">celery</span>
</pre></div>
</div>
<p>Implement your function, specifying the arguments you wish it to take. For our
sample we will use a simple echo task that will print out its argument to the
console:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">echo</span><span class="p">(</span> <span class="n">message</span> <span class="p">):</span>
  <span class="k">print</span> <span class="n">message</span>
</pre></div>
</div>
<p>Next it is important to decorate your function with the celery task decorator.
You should give the task a name, which is used later on when calling the task:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@celery.task</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;NAME.echofunction&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">echo</span><span class="p">(</span> <span class="n">message</span> <span class="p">):</span>
  <span class="k">print</span> <span class="n">message</span>
</pre></div>
</div>
<p>That&#8217;s it, your function is ready to be run asynchronously outside of the main
execution of the CKAN app.  Next you should make sure you run <code class="docutils literal"><span class="pre">python</span> <span class="pre">setup.py</span>
<span class="pre">develop</span></code> in your extensions folder and then go to your CKAN installation
folder (normally pyenv/src/ckan/) to run the following command:</p>
<div class="highlight-python"><div class="highlight"><pre>paster celeryd
</pre></div>
</div>
<p>Once you have done this your task name <code class="docutils literal"><span class="pre">NAME.echofunction</span></code> should appear in
the list of tasks loaded. If it is there then you are all set and ready to go.
If not then you should try the following to try and resolve the problem:</p>
<ol class="arabic simple">
<li>Make sure the entry point is defined correctly in your <code class="docutils literal"><span class="pre">setup.py</span></code> and that
you have executed <code class="docutils literal"><span class="pre">python</span> <span class="pre">setup.py</span> <span class="pre">develop</span></code></li>
<li>Check that your task_imports function returns an iterable with valid module
names in</li>
<li>Ensure that the decorator marks the functions (if there is more than one
decorator, make sure the celery.task is the first one - which means it will
execute last).</li>
<li>If none of the above helps, go into #ckan on irc.freenode.net where there
should be people who can help you resolve your issue.</li>
</ol>
</div>
<div class="section" id="calling-the-task">
<h3>Calling the task<a class="headerlink" href="background-tasks.html#calling-the-task" title="Permalink to this headline">¶</a></h3>
<p>Now that the task is defined, and has been loaded by celery it is ready to be
called.  To call a background task you need to know only the name of the task,
and the arguments that it expects as well as providing it a task id.:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">ckan.lib.celery_app</span> <span class="kn">import</span> <span class="n">celery</span>
<span class="n">celery</span><span class="o">.</span><span class="n">send_task</span><span class="p">(</span><span class="s">&quot;NAME.echofunction&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;Hello World&quot;</span><span class="p">],</span> <span class="n">task_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()))</span>
</pre></div>
</div>
<p>After executing this code you should see the message printed in the console
where you ran <code class="docutils literal"><span class="pre">paster</span> <span class="pre">celeryd</span></code>.</p>
</div>
<div class="section" id="retrying-on-errors">
<h3>Retrying on errors<a class="headerlink" href="background-tasks.html#retrying-on-errors" title="Permalink to this headline">¶</a></h3>
<p>Should your task fail to complete because of a transient error, it is possible
to ask celery to retry the task, after some period of time.  The default wait
before retrying is three minutes, but you can optionally specify this in the
call to retry via the countdown parameter, and you can also specify the
exception that triggered the failure.  For our example the call to retry would
look like the following - note that it calls the function name, not the task
name given in the decorator:</p>
<div class="highlight-python"><div class="highlight"><pre>try:
  ... some work that may fail, http request?
except Exception, e:
  # Retry again in 2 minutes
  echo.retry(args=(message), exc=e, countdown=120, max_retries=10)
</pre></div>
</div>
<p>If you don&#8217;t want to wait a period of time you can use the eta datetime
parameter to specify an explicit time to run the task (i.e. 9AM tomorrow)</p>
</div>
</div>
</div>



        
        <div style="font-size:smaller;">
          <hr/>
          
            
          
            
              <div class="pull-right">
                <a href="email-notifications.html"
                  title="Email Notifications" accesskey="N">
                    
                      
                    
                    Email Notifications→
                </a>
              </div>
            
          
            
              <div >
                <a href="linked-data-and-rdf.html"
                  title="Linked Data and RDF" accesskey="P">
                    
                      
                    
                    ← Linked Data and RDF
                </a>
              </div>
            
          
          <div style="clear:both;"></div>
        </div>

      </div>
    </div>
  </div> <!-- / row -->
</div>

<footer>
  <div class="inner">
    <div class="container-fluid">
      <p>An <a href="http://okfn.org">Open Knowledge Foundation</a> project.</p>

<p class="copyright">
  &copy; 2009-2012, <a href="http://okfn.org/">Open Knowledge Foundation</a>.
    Licensed under <a
    href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons
    Attribution ShareAlike (Unported) v3.0 License</a>.<br />
    <img src="http://i.creativecommons.org/l/by-sa/3.0/80x15.png" alt="CC License Logo" />
    <a href="http://opendefinition.org/"><img src="http://assets.okfn.org/images/ok_buttons/oc_80x15_blue.png" border="0" 
      alt="{{ _('Open Content') }}" /></a>
  <br/>
</p>

<p>
<a href="https://github.com/okfn/ckan">Source</a>
&mdash;
<a href="https://github.com/okfn/ckan/issues">Issues</a>
&mdash;
<a href="http://lists.okfn.org/mailman/listinfo/ckan-dev">Mailing List</a>
&mdash;
<a href="http://twitter.com/CKANProject">Twitter @CKANProject</a>
</p>

<p>
Related Projects:
<a href="http://thedatahub.org/">The DataHub</a>
&mdash;
<a href="http://datacatalogs.org">DataCatalogs.org</a>
&mdash;
<a href="http://openspending.org">OpenSpending.org</a>
&mdash;
<a href="http://opendatahandbook.org">Open Data Handbook</a>
</p>

    </div>
  </div>
</footer>



  </body>
</html>