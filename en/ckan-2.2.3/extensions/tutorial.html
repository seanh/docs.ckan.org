<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Writing extensions tutorial &mdash; CKAN 2.2.3 documentation</title>
    
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/css/bootstrap.css" type="text/css" />
    <link rel="stylesheet" href="../_static/css/fix.css" type="text/css" />
    <link rel="stylesheet" href="../_static/css/bootstrap-responsive.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="https://media.readthedocs.org/css/badge_only.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.2.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="https://media.readthedocs.org/javascript/jquery/jquery-2.0.3.min.js"></script>
    <script type="text/javascript" src="https://media.readthedocs.org/javascript/jquery/jquery-migrate-1.2.1.min.js"></script>
    <script type="text/javascript" src="https://media.readthedocs.org/javascript/underscore.js"></script>
    <script type="text/javascript" src="https://media.readthedocs.org/javascript/doctools.js"></script>
    <script type="text/javascript" src="https://media.readthedocs.org/javascript/readthedocs-doc-embed.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-css-tweaks.js"></script>
    <link rel="top" title="CKAN 2.2.3 documentation" href="../index.html" />
    <link rel="up" title="Writing CKAN extensions" href="index.html" />
    <link rel="next" title="Testing extensions" href="testing-extensions.html" />
    <link rel="prev" title="Writing CKAN extensions" href="index.html" />

  
<!-- RTD Extra Head -->

<!-- 
Always link to the latest version, as canonical.
http://docs.readthedocs.org/en/latest/canonical.html
-->
<link rel="canonical" href="http://docs.ckan.org/en/latest/extensions/tutorial.html" />

<link rel="stylesheet" href="https://media.readthedocs.org/css/readthedocs-doc-embed.css" type="text/css" />

<script type="text/javascript" src="../_static/readthedocs-data.js"></script>

<!-- Add page-specific data, which must exist in the page js, not global -->
<script type="text/javascript">
READTHEDOCS_DATA['page'] = 'extensions/tutorial'
</script>

<script type="text/javascript" src="../_static/readthedocs-dynamic-include.js"></script>

<!-- end RTD <extrahead> --></head>
  <body>
  
  <div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
      <div class="container-fluid">
        
        <a class="logo-icon pull-left" href="../contents.html"><img src="../_static/ckanlogo.png" alt="CKAN" /></a>
        
        <a class="brand" href="../contents.html">CKAN<span class="version"> v2.2.3</span></a>
        
        
        <a class="okfn-logo pull-right" href="http://okfn.org/" title="An Open Knowledge Foundation Project">
          <img src="https://s3.amazonaws.com/assets.okfn.org/p/okfn/img/logo_28x30.png" alt="Open Knowledge Foundation logo" />
        </a>
        
        
          
<form class="pull-right navbar-search" action="http://docs.ckan.org/en/ckan-2.2.3/search.html" method="get">
  <input type="text" name="q" placeholder="Search" class="search-query span2" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        
      </div>
    </div>
  </div>

<div class="container-fluid">
  <div class="row-fluid">
    <div class="span4">
      <div class="well sidebar-nav">
        
          
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper"><div class="widget toc">
  <h3>Table of Contents</h3>
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Welcome to CKAN&#8217;s Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-guide.html">User guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sysadmin-guide.html">Sysadmin guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installing.html">Installing CKAN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../upgrading.html">Upgrading CKAN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../features.html">Features</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Writing CKAN extensions</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="tutorial.html">Writing extensions tutorial</a><ul>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#installing-ckan">Installing CKAN</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#creating-a-new-extension">Creating a new extension</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#creating-a-plugin-class">Creating a plugin class</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#adding-the-plugin-to-setup-py">Adding the plugin to <tt class="docutils literal"><span class="pre">setup.py</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#installing-the-extension">Installing the extension</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#enabling-the-plugin">Enabling the plugin</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#implementing-the-iauthfunctions-plugin-interface">Implementing the <tt class="docutils literal"><span class="pre">IAuthFunctions</span></tt> plugin interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#using-the-plugins-toolkit">Using the plugins toolkit</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#exception-handling">Exception handling</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#we-re-done">We&#8217;re done!</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#id2">Troubleshooting</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="testing-extensions.html">Testing extensions</a></li>
<li class="toctree-l2"><a class="reference internal" href="best-practices.html">Best practices for writing extensions</a></li>
<li class="toctree-l2"><a class="reference internal" href="plugin-interfaces.html">Plugin interfaces reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="plugins-toolkit.html">Plugins toolkit reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="converters.html">Converter functions reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="validators.html">Validator functions reference</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../theming.html">Theming</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">The CKAN API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing to CKAN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../test.html">Testing CKAN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../configuration.html">Config File Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendices/index.html">Appendices</a></li>
</ul>

</div>

        </div>
      </div>
        
      </div><!--/.well -->
    </div><!--/span-->
    <div class="span8">
      <div class="content">

        
        <div style="font-size:smaller;">
              <a href="../contents.html">CKAN 2.2.3 documentation</a> &raquo;
              <a href="index.html"
                    accesskey="U">
                    Writing CKAN extensions
                  </a>
                   &raquo;
        </div>

        
  <div class="section" id="writing-extensions-tutorial">
<h1>Writing extensions tutorial<a class="headerlink" href="tutorial.html#writing-extensions-tutorial" title="Permalink to this headline">¶</a></h1>
<p>This tutorial will walk you through the process of creating a simple CKAN
extension, and introduce the core concepts that CKAN extension developers need
to know along the way. As an example, we&#8217;ll use the
<tt class="xref py py-mod docutils literal"><span class="pre">example_iauthfunctions</span></tt> extension that&#8217;s packaged with CKAN.
This is a simple CKAN extension that customizes some of CKAN&#8217;s authorization
rules.</p>
<div class="section" id="installing-ckan">
<h2>Installing CKAN<a class="headerlink" href="tutorial.html#installing-ckan" title="Permalink to this headline">¶</a></h2>
<p>Before you can start developing a CKAN extension, you&#8217;ll need a working source
install of CKAN on your system. If you don&#8217;t have a CKAN source install
already, follow the instructions in <a class="reference internal" href="../install-from-source.html"><em>Installing CKAN from source</em></a> before
continuing.</p>
</div>
<div class="section" id="creating-a-new-extension">
<h2>Creating a new extension<a class="headerlink" href="tutorial.html#creating-a-new-extension" title="Permalink to this headline">¶</a></h2>
<div class="topic">
<p class="topic-title first">Extensions</p>
<p>A CKAN <em>extension</em> is a Python package that modifies or extends CKAN.
Each extension contains one or more <em>plugins</em> that must be added to your
CKAN config file to activate the extension&#8217;s features.</p>
</div>
<p>You can use the <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">create</span></tt> command to create an &#8220;empty&#8221; extension from
a template. First, activate your CKAN virtual environment:</p>
<pre class="literal-block">
. /usr/lib/ckan/default/bin/activate
</pre>
<p>When you run the <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">create</span></tt> command, your new extension&#8217;s directory will
be created in the current working directory by default (you can override this
with the <tt class="docutils literal"><span class="pre">-o</span></tt> option), so change to the directory that you want your
extension to be created in. Usually you&#8217;ll want to track your extension code
using a version control system such as <tt class="docutils literal"><span class="pre">git</span></tt>, so you wouldn&#8217;t want to create
your extension in the <tt class="docutils literal"><span class="pre">ckan</span></tt> source directory because that directory already
contains the CKAN git repo. Let&#8217;s use the parent directory instead:</p>
<pre class="literal-block">
cd /usr/lib/ckan/default/src
</pre>
<p>Now run the <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">create</span></tt> command to create your extension:</p>
<div class="highlight-python"><div class="highlight"><pre>paster --plugin=ckan create -t ckanext ckanext-iauthfunctions
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The last argument to the <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">create</span></tt> command
(<tt class="docutils literal"><span class="pre">ckanext-iauthfunctions</span></tt> in this example) is the name for your next
extension. CKAN extension names <em>have</em> to begin with <tt class="docutils literal"><span class="pre">ckanext-</span></tt>.</p>
</div>
<p>The command will ask you to answer a few questions. The answers you give will
end up in your extension&#8217;s <tt class="docutils literal"><span class="pre">setup.py</span></tt> file (where you can edit them later if
you want).</p>
<p>Once this command has completed, your new CKAN extension&#8217;s project
directory will have been created and will contain a few directories and files
to get you started:</p>
<div class="highlight-python"><div class="highlight"><pre>ckanext-iauthfunctions/
    ckanext/
        __init__.py
        iauthfunctions/
            __init__.py
    ckanext_iauthfunctions.egg-info/
    setup.py
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">ckanext_iauthfunctions.egg_info</span></tt> is a directory containing automatically
generated metadata about your project. It&#8217;s used by Python&#8217;s packaging and
distribution tools. In general, you don&#8217;t need to edit or look at anything in
this directory, and you should not add it to version control.</p>
<p><tt class="docutils literal"><span class="pre">setup.py</span></tt> is the setup script for your project. As you&#8217;ll see later, you use
this script to install your project into a virtual environment. It contains
several settings that you&#8217;ll update as you develop your project.</p>
<p><tt class="docutils literal"><span class="pre">ckanext/iauthfunctions</span></tt> is the Python package directory where we&#8217;ll add the
source code files for our extension.</p>
</div>
<div class="section" id="creating-a-plugin-class">
<h2>Creating a plugin class<a class="headerlink" href="tutorial.html#creating-a-plugin-class" title="Permalink to this headline">¶</a></h2>
<div class="topic">
<p class="topic-title first">Plugins</p>
<p>Each CKAN extension contains one or more plugins that provide the
extension&#8217;s features.</p>
</div>
<p>Now create the file <tt class="docutils literal"><span class="pre">ckanext-iauthfunctions/ckanext/iauthfunctions/plugin.py</span></tt>
with the following contents:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">ckan.plugins</span> <span class="kn">as</span> <span class="nn">plugins</span>


<span class="k">class</span> <span class="nc">ExampleIAuthFunctionsPlugin</span><span class="p">(</span><span class="n">plugins</span><span class="o">.</span><span class="n">SingletonPlugin</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>Our plugin is a normal Python class, named
<tt class="xref py py-class docutils literal"><span class="pre">ExampleIAuthFunctionsPlugin</span></tt>
in this example, that inherits from CKAN&#8217;s
<tt class="xref py py-class docutils literal"><span class="pre">SingletonPlugin</span></tt> class.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Every CKAN plugin class should inherit from
<tt class="xref py py-class docutils literal"><span class="pre">SingletonPlugin</span></tt>.</p>
</div>
</div>
<div class="section" id="adding-the-plugin-to-setup-py">
<span id="setup-py"></span><h2>Adding the plugin to <tt class="docutils literal"><span class="pre">setup.py</span></tt><a class="headerlink" href="tutorial.html#adding-the-plugin-to-setup-py" title="Permalink to this headline">¶</a></h2>
<p>Now let&#8217;s add our class to the <tt class="docutils literal"><span class="pre">entry_points</span></tt> in <tt class="docutils literal"><span class="pre">setup.py</span></tt>.  This
identifies the plugin class to CKAN once the extension is installed in CKAN&#8217;s
virtualenv, and associates a plugin name with the class.  Edit
<tt class="docutils literal"><span class="pre">ckanext-iauthfunctions/setup.py</span></tt> and add a line to
the <tt class="docutils literal"><span class="pre">entry_points</span></tt> section like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">entry_points</span><span class="o">=</span><span class="s">&#39;&#39;&#39;</span>
<span class="s">    [ckan.plugins]</span>
<span class="s">    example_iauthfunctions=ckanext.iauthfunctions.plugin:ExampleIAuthFunctionsPlugin</span>
<span class="s">&#39;&#39;&#39;</span><span class="p">,</span>
</pre></div>
</div>
</div>
<div class="section" id="installing-the-extension">
<h2>Installing the extension<a class="headerlink" href="tutorial.html#installing-the-extension" title="Permalink to this headline">¶</a></h2>
<p>When you <a class="reference internal" href="../installing.html"><em>install CKAN</em></a>, you create a Python <a class="reference external" href="http://www.virtualenv.org">virtual
environment</a> in a directory on your system
(/usr/lib/ckan/default by default) and install the CKAN Python package and the other
packages that CKAN depends on into this virtual environment.
Before we can use our plugin, we must install our extension into our CKAN
virtual environment.</p>
<p>Make sure your virtualenv is activated, change to the extension&#8217;s
directory, and run <tt class="docutils literal"><span class="pre">python</span> <span class="pre">setup.py</span> <span class="pre">develop</span></tt>:</p>
<pre class="literal-block">
. /usr/lib/ckan/default/bin/activate
cd /usr/lib/ckan/default/src/ckanext-iauthfunctions
python setup.py develop
</pre>
</div>
<div class="section" id="enabling-the-plugin">
<h2>Enabling the plugin<a class="headerlink" href="tutorial.html#enabling-the-plugin" title="Permalink to this headline">¶</a></h2>
<p>An extension&#8217;s plugins must be added to the <a class="reference internal" href="../configuration.html#ckan-plugins"><em>ckan.plugins</em></a> setting in your
CKAN config file so that CKAN will call the plugins&#8217; methods.  The name that
you gave to your plugin class in the <a class="reference internal" href="tutorial.html#setup-py"><em>left-hand-side of the assignment in
the setup.py file</em></a> (<tt class="docutils literal"><span class="pre">example_iauthfunctions</span></tt> in this example) is
the name you&#8217;ll use for your plugin in CKAN&#8217;s config file:</p>
<div class="highlight-python"><div class="highlight"><pre>ckan.plugins = stats text_preview recline_preview example_iauthfunctions
</pre></div>
</div>
<p>You should now be able to start CKAN in the development web server and have it
start up without any problems:</p>
<pre class="literal-block">
$ paster serve /etc/ckan/default/development.ini
Starting server in PID 13961.
serving on 0.0.0.0:5000 view at <a class="reference external" href="http://127.0.0.1:5000">http://127.0.0.1:5000</a>
</pre>
<p>If your plugin is in the <a class="reference internal" href="../configuration.html#ckan-plugins"><em>ckan.plugins</em></a> setting and CKAN starts without
crashing, then your plugin is installed and CKAN can find it. Of course, your
plugin doesn&#8217;t <em>do</em> anything yet.</p>
</div>
<div class="section" id="troubleshooting">
<h2>Troubleshooting<a class="headerlink" href="tutorial.html#troubleshooting" title="Permalink to this headline">¶</a></h2>
<div class="section" id="pluginnotfoundexception">
<h3><tt class="docutils literal"><span class="pre">PluginNotFoundException</span></tt><a class="headerlink" href="tutorial.html#pluginnotfoundexception" title="Permalink to this headline">¶</a></h3>
<p>If CKAN crashes with a <tt class="xref py py-exc docutils literal"><span class="pre">PluginNotFoundException</span></tt>
like this:</p>
<div class="highlight-python"><div class="highlight"><pre>ckan.plugins.core.PluginNotFoundException: example_iauthfunctions
</pre></div>
</div>
<p>then:</p>
<ul class="simple">
<li>Check that the name you&#8217;ve used for your plugin in your CKAN config file is
the same as the name you&#8217;ve used in your extension&#8217;s <tt class="docutils literal"><span class="pre">setup.py</span></tt> file</li>
<li>Check that you&#8217;ve run <tt class="docutils literal"><span class="pre">python</span> <span class="pre">setup.py</span> <span class="pre">develop</span></tt> in your extension&#8217;s
directory, with your CKAN virtual environment activated. Every time you add
a new plugin to your extension&#8217;s <tt class="docutils literal"><span class="pre">setup.py</span></tt> file, you need to run
<tt class="docutils literal"><span class="pre">python</span> <span class="pre">setup.py</span> <span class="pre">develop</span></tt> again before you can use the new plugin.</li>
</ul>
</div>
<div class="section" id="importerror">
<h3><tt class="docutils literal"><span class="pre">ImportError</span></tt><a class="headerlink" href="tutorial.html#importerror" title="Permalink to this headline">¶</a></h3>
<p>If you get an <tt class="docutils literal"><span class="pre">ImportError</span></tt> from CKAN relating to your plugin, it&#8217;s probably
because the path to your plugin class in your <tt class="docutils literal"><span class="pre">setup.py</span></tt> file is wrong.</p>
</div>
</div>
<div class="section" id="implementing-the-iauthfunctions-plugin-interface">
<h2>Implementing the <a class="reference internal" href="plugin-interfaces.html#ckan.plugins.interfaces.IAuthFunctions" title="ckan.plugins.interfaces.IAuthFunctions"><tt class="xref py py-class docutils literal"><span class="pre">IAuthFunctions</span></tt></a> plugin interface<a class="headerlink" href="tutorial.html#implementing-the-iauthfunctions-plugin-interface" title="Permalink to this headline">¶</a></h2>
<div class="topic">
<p class="topic-title first">Plugin interfaces</p>
<p>CKAN provides a number of
<a class="reference internal" href="plugin-interfaces.html"><em>plugin interfaces</em></a> that plugins must
implement to hook into CKAN and modify or extend it. Each plugin interface
defines a number of methods that a plugin that implements the interface must
provide. CKAN will call your plugin&#8217;s implementations of these methods, to
allow your plugin to do its stuff.</p>
</div>
<p>To modify CKAN&#8217;s authorization behavior, we&#8217;ll implement the
<a class="reference internal" href="plugin-interfaces.html#ckan.plugins.interfaces.IAuthFunctions" title="ckan.plugins.interfaces.IAuthFunctions"><tt class="xref py py-class docutils literal"><span class="pre">IAuthFunctions</span></tt></a> plugin interface.  This
interface defines just one method, that takes no parameters and returns a
dictionary:</p>
<table border="1" class="longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><a class="reference internal" href="plugin-interfaces.html#ckan.plugins.interfaces.IAuthFunctions.get_auth_functions" title="ckan.plugins.interfaces.IAuthFunctions.get_auth_functions"><tt class="xref py py-obj docutils literal"><span class="pre">get_auth_functions</span></tt></a>()</td>
<td>Return the authorization functions provided by this plugin.</td>
</tr>
</tbody>
</table>
<div class="topic">
<p class="topic-title first">Action functions and authorization functions</p>
<p>At this point, it&#8217;s necessary to take a short diversion to explain how
authorization works in CKAN.</p>
<p>Every action that can be carried out using the CKAN web interface or API is
implemented by an <em>action function</em> in one of the four files
<tt class="docutils literal"><span class="pre">ckan/logic/action/{create,delete,get,update}.py</span></tt>.</p>
<p>For example, when creating a dataset either using the web interface or using
the <a class="reference internal" href="../api.html#ckan.logic.action.create.package_create" title="ckan.logic.action.create.package_create"><tt class="xref py py-func docutils literal"><span class="pre">package_create()</span></tt></a> API call,
<a class="reference internal" href="../api.html#ckan.logic.action.create.package_create" title="ckan.logic.action.create.package_create"><tt class="xref py py-func docutils literal"><span class="pre">ckan.logic.action.create.package_create()</span></tt></a> is called. There&#8217;s also
<a class="reference internal" href="../api.html#ckan.logic.action.get.package_show" title="ckan.logic.action.get.package_show"><tt class="xref py py-func docutils literal"><span class="pre">ckan.logic.action.get.package_show()</span></tt></a>,
<a class="reference internal" href="../api.html#ckan.logic.action.update.package_update" title="ckan.logic.action.update.package_update"><tt class="xref py py-func docutils literal"><span class="pre">ckan.logic.action.update.package_update()</span></tt></a>, and
<a class="reference internal" href="../api.html#ckan.logic.action.delete.package_delete" title="ckan.logic.action.delete.package_delete"><tt class="xref py py-func docutils literal"><span class="pre">ckan.logic.action.delete.package_delete()</span></tt></a>.</p>
<p>For a full list of the action functions available in CKAN, see the
<a class="reference internal" href="../api.html#api-reference"><em>Action API reference</em></a>.</p>
<p>Each action function has a corresponding authorization function in one of
the four files <tt class="docutils literal"><span class="pre">ckan/logic/auth/{create,delete,get,update}.py</span></tt>,
CKAN calls this authorization function to decide whether
the user is authorized to carry out the requested action. For example, when
creating a new package using the web interface or API,
<tt class="xref py py-func docutils literal"><span class="pre">ckan.logic.auth.create.package_create()</span></tt> is called.</p>
<p>The <a class="reference internal" href="plugin-interfaces.html#ckan.plugins.interfaces.IAuthFunctions" title="ckan.plugins.interfaces.IAuthFunctions"><tt class="xref py py-class docutils literal"><span class="pre">IAuthFunctions</span></tt></a> plugin interface
allows CKAN plugins to hook into this authorization system to add their own
authorization functions or override the default authorization functions. In
this way, plugins have complete control to customize CKAN&#8217;s auth.</p>
</div>
<p>Whenever a user tries to create a new group via the web interface or the API,
CKAN calls the <tt class="xref py py-func docutils literal"><span class="pre">group_create()</span></tt> authorization
function to decide whether to allow the action. Let&#8217;s override this function
and simply prevent anyone from creating new groups. Edit your <tt class="docutils literal"><span class="pre">plugin.py</span></tt>
file so that it looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">ckan.plugins</span> <span class="kn">as</span> <span class="nn">plugins</span>


<span class="k">def</span> <span class="nf">group_create</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">data_dict</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">&#39;success&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s">&#39;msg&#39;</span><span class="p">:</span> <span class="s">&#39;No one is allowed to create groups&#39;</span><span class="p">}</span>


<span class="k">class</span> <span class="nc">ExampleIAuthFunctionsPlugin</span><span class="p">(</span><span class="n">plugins</span><span class="o">.</span><span class="n">SingletonPlugin</span><span class="p">):</span>
    <span class="n">plugins</span><span class="o">.</span><span class="n">implements</span><span class="p">(</span><span class="n">plugins</span><span class="o">.</span><span class="n">IAuthFunctions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_auth_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&#39;group_create&#39;</span><span class="p">:</span> <span class="n">group_create</span><span class="p">}</span>
</pre></div>
</div>
<p>Our <tt class="xref py py-class docutils literal"><span class="pre">ExampleIAuthFunctionsPlugin</span></tt>
class now calls <tt class="xref py py-func docutils literal"><span class="pre">implements()</span></tt> to tell CKAN that it
implements the <a class="reference internal" href="plugin-interfaces.html#ckan.plugins.interfaces.IAuthFunctions" title="ckan.plugins.interfaces.IAuthFunctions"><tt class="xref py py-class docutils literal"><span class="pre">IAuthFunctions</span></tt></a> interface, and
provides an implementation of the interface&#8217;s
<a class="reference internal" href="plugin-interfaces.html#ckan.plugins.interfaces.IAuthFunctions.get_auth_functions" title="ckan.plugins.interfaces.IAuthFunctions.get_auth_functions"><tt class="xref py py-func docutils literal"><span class="pre">get_auth_functions()</span></tt></a> method that
overrides the default <tt class="xref py py-func docutils literal"><span class="pre">group_create()</span></tt> function
with a custom one. This custom function simply returns <tt class="docutils literal"><span class="pre">{'success':</span> <span class="pre">False}</span></tt>
to refuse to let anyone create a new group.</p>
<p>If you now restart CKAN and reload the <tt class="docutils literal"><span class="pre">/group</span></tt> page, as long as you&#8217;re not a
sysadmin user you should see the <tt class="docutils literal"><span class="pre">Add</span> <span class="pre">Group</span></tt> button disappear. The CKAN web
interface automatically hides buttons that the user is not authorized to use.
Visiting <tt class="docutils literal"><span class="pre">/group/new</span></tt>  directly will redirect you to the login page. If you
try to call <a class="reference internal" href="../api.html#ckan.logic.action.create.group_create" title="ckan.logic.action.create.group_create"><tt class="xref py py-func docutils literal"><span class="pre">group_create()</span></tt></a> via the API, you&#8217;ll
receive an <tt class="docutils literal"><span class="pre">Authorization</span> <span class="pre">Error</span></tt> from CKAN:</p>
<div class="highlight-python"><div class="highlight"><pre>$ http 127.0.0.1:5000/api/3/action/group_create Authorization:*** name=my_group
HTTP/1.0 403 Forbidden
Access-Control-Allow-Headers: X-CKAN-API-KEY, Authorization, Content-Type
Access-Control-Allow-Methods: POST, PUT, GET, DELETE, OPTIONS
Access-Control-Allow-Origin: *
Cache-Control: no-cache
Content-Length: 2866
Content-Type: application/json;charset=utf-8
Date: Wed, 12 Jun 2013 13:38:01 GMT
Pragma: no-cache
Server: PasteWSGIServer/0.5 Python/2.7.4

{
    &quot;error&quot;: {
        &quot;__type&quot;: &quot;Authorization Error&quot;,
        &quot;message&quot;: &quot;Access denied&quot;
    },
    &quot;help&quot;: &quot;Create a new group...&quot;,
    &quot;success&quot;: false
}
</pre></div>
</div>
<p>If you&#8217;re logged in as a sysadmin user however, you&#8217;ll still be able to create
new groups. Sysadmin users can always carry out any action, they bypass the
authorization functions.</p>
</div>
<div class="section" id="using-the-plugins-toolkit">
<h2>Using the plugins toolkit<a class="headerlink" href="tutorial.html#using-the-plugins-toolkit" title="Permalink to this headline">¶</a></h2>
<p>Let&#8217;s make our custom authorization function a little smarter, and allow only
users who are members of a particular group named <tt class="docutils literal"><span class="pre">curators</span></tt> to create new
groups.</p>
<p>First run CKAN, login and then create a new group called <tt class="docutils literal"><span class="pre">curators</span></tt>.  Then
edit <tt class="docutils literal"><span class="pre">plugin.py</span></tt> so that it looks like this:</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This version of <tt class="docutils literal"><span class="pre">plugin.py</span></tt> will crash if the user is not logged in or if
the site doesn&#8217;t have a group called <tt class="docutils literal"><span class="pre">curators</span></tt>. You&#8217;ll want to create
a <tt class="docutils literal"><span class="pre">curators</span></tt> group in your CKAN before editing your plugin to look like
this. See <a class="reference internal" href="tutorial.html#exception-handling"><em>Exception handling</em></a> below.</p>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">ckan.plugins</span> <span class="kn">as</span> <span class="nn">plugins</span>
<span class="kn">import</span> <span class="nn">ckan.plugins.toolkit</span> <span class="kn">as</span> <span class="nn">toolkit</span>


<span class="k">def</span> <span class="nf">group_create</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">data_dict</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="c"># Get the user name of the logged-in user.</span>
    <span class="n">user_name</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s">&#39;user&#39;</span><span class="p">]</span>

    <span class="c"># Get a list of the members of the &#39;curators&#39; group.</span>
    <span class="n">members</span> <span class="o">=</span> <span class="n">toolkit</span><span class="o">.</span><span class="n">get_action</span><span class="p">(</span><span class="s">&#39;member_list&#39;</span><span class="p">)(</span>
        <span class="n">data_dict</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="s">&#39;curators&#39;</span><span class="p">,</span> <span class="s">&#39;object_type&#39;</span><span class="p">:</span> <span class="s">&#39;user&#39;</span><span class="p">})</span>

    <span class="c"># &#39;members&#39; is a list of (user_id, object_type, capacity) tuples, we&#39;re</span>
    <span class="c"># only interested in the user_ids.</span>
    <span class="n">member_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">member_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">member_tuple</span> <span class="ow">in</span> <span class="n">members</span><span class="p">]</span>

    <span class="c"># We have the logged-in user&#39;s user name, get their user id.</span>
    <span class="n">convert_user_name_or_id_to_id</span> <span class="o">=</span> <span class="n">toolkit</span><span class="o">.</span><span class="n">get_converter</span><span class="p">(</span>
        <span class="s">&#39;convert_user_name_or_id_to_id&#39;</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">convert_user_name_or_id_to_id</span><span class="p">(</span><span class="n">user_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

    <span class="c"># Finally, we can test whether the user is a member of the curators group.</span>
    <span class="k">if</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="n">member_ids</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&#39;success&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&#39;success&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                <span class="s">&#39;msg&#39;</span><span class="p">:</span> <span class="s">&#39;Only curators are allowed to create groups&#39;</span><span class="p">}</span>


<span class="k">class</span> <span class="nc">ExampleIAuthFunctionsPlugin</span><span class="p">(</span><span class="n">plugins</span><span class="o">.</span><span class="n">SingletonPlugin</span><span class="p">):</span>
    <span class="n">plugins</span><span class="o">.</span><span class="n">implements</span><span class="p">(</span><span class="n">plugins</span><span class="o">.</span><span class="n">IAuthFunctions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_auth_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&#39;group_create&#39;</span><span class="p">:</span> <span class="n">group_create</span><span class="p">}</span>
</pre></div>
</div>
<div class="section" id="context">
<h3><tt class="docutils literal"><span class="pre">context</span></tt><a class="headerlink" href="tutorial.html#context" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">context</span></tt> parameter of our
<tt class="xref py py-func docutils literal"><span class="pre">group_create()</span></tt> function is
a dictionary that CKAN passes to all authorization and action functions
containing some computed variables. Our function gets the name of the logged-in
user from <tt class="docutils literal"><span class="pre">context</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre>    <span class="n">user_name</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s">&#39;user&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="data-dict">
<h3><tt class="docutils literal"><span class="pre">data_dict</span></tt><a class="headerlink" href="tutorial.html#data-dict" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">data_dict</span></tt> parameter of our
<tt class="xref py py-func docutils literal"><span class="pre">group_create()</span></tt> function is
another dictionary that CKAN passes to all authorization and action functions.
<tt class="docutils literal"><span class="pre">data_dict</span></tt> contains any data posted by the user to CKAN, eg. any fields
they&#8217;ve completed in a web form they&#8217;re submitting or any <tt class="docutils literal"><span class="pre">JSON</span></tt> fields
they&#8217;ve posted to the API. If we inspect the contents of the <tt class="docutils literal"><span class="pre">data_dict</span></tt>
passed to our <tt class="docutils literal"><span class="pre">group_create()</span></tt> authorization function, we&#8217;ll see that it
contains the details of the group the user wants to create:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span><span class="s">&#39;description&#39;</span><span class="p">:</span> <span class="s">u&#39;A really cool group&#39;</span><span class="p">,</span>
 <span class="s">&#39;image_url&#39;</span><span class="p">:</span> <span class="s">u&#39;&#39;</span><span class="p">,</span>
 <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">u&#39;my_group&#39;</span><span class="p">,</span>
 <span class="s">&#39;title&#39;</span><span class="p">:</span> <span class="s">u&#39;My Group&#39;</span><span class="p">,</span>
 <span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;group&#39;</span><span class="p">,</span>
 <span class="s">&#39;users&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s">&#39;capacity&#39;</span><span class="p">:</span> <span class="s">&#39;admin&#39;</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">u&#39;seanh&#39;</span><span class="p">}]}</span>
</pre></div>
</div>
</div>
<div class="section" id="the-plugins-toolkit">
<h3>The plugins toolkit<a class="headerlink" href="tutorial.html#the-plugins-toolkit" title="Permalink to this headline">¶</a></h3>
<p>CKAN&#8217;s <a class="reference internal" href="plugins-toolkit.html"><em>plugins toolkit</em></a> is a Python module containing
core CKAN functions, classes and exceptions for use by CKAN extensions.</p>
<p>The toolkit&#8217;s <a class="reference internal" href="plugins-toolkit.html#ckan.plugins.toolkit.get_action" title="ckan.plugins.toolkit.get_action"><tt class="xref py py-func docutils literal"><span class="pre">get_action()</span></tt></a> function returns a CKAN
action function. The action functions available to extensions are the same
functions that CKAN uses internally to carry out actions when users make
requests to the web interface or API. Our code uses
<a class="reference internal" href="plugins-toolkit.html#ckan.plugins.toolkit.get_action" title="ckan.plugins.toolkit.get_action"><tt class="xref py py-func docutils literal"><span class="pre">get_action()</span></tt></a> to get the
<a class="reference internal" href="../api.html#ckan.logic.action.get.member_list" title="ckan.logic.action.get.member_list"><tt class="xref py py-func docutils literal"><span class="pre">member_list()</span></tt></a> action function, which it uses to
get a list of the members of the <tt class="docutils literal"><span class="pre">curators</span></tt> group:</p>
<div class="highlight-python"><div class="highlight"><pre>    <span class="n">members</span> <span class="o">=</span> <span class="n">toolkit</span><span class="o">.</span><span class="n">get_action</span><span class="p">(</span><span class="s">&#39;member_list&#39;</span><span class="p">)(</span>
        <span class="n">data_dict</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="s">&#39;curators&#39;</span><span class="p">,</span> <span class="s">&#39;object_type&#39;</span><span class="p">:</span> <span class="s">&#39;user&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>Calling <a class="reference internal" href="../api.html#ckan.logic.action.get.member_list" title="ckan.logic.action.get.member_list"><tt class="xref py py-func docutils literal"><span class="pre">member_list()</span></tt></a> in this way is equivalent to
posting the same data dict to the <tt class="docutils literal"><span class="pre">/api/3/action/member_list</span></tt> API endpoint.
For other action functions available from
<a class="reference internal" href="plugins-toolkit.html#ckan.plugins.toolkit.get_action" title="ckan.plugins.toolkit.get_action"><tt class="xref py py-func docutils literal"><span class="pre">get_action()</span></tt></a>, see <a class="reference internal" href="../api.html#api-reference"><em>Action API reference</em></a>.</p>
<p>The toolkit&#8217;s <a class="reference internal" href="plugins-toolkit.html#ckan.plugins.toolkit.get_converter" title="ckan.plugins.toolkit.get_converter"><tt class="xref py py-func docutils literal"><span class="pre">get_converter()</span></tt></a> function returns
converter functions from <a class="reference internal" href="converters.html#module-ckan.logic.converters" title="ckan.logic.converters"><tt class="xref py py-mod docutils literal"><span class="pre">ckan.logic.converters</span></tt></a> for plugins to use.  This
is the same set of converter functions that CKAN&#8217;s action functions use to
convert user-provided data. Our code uses
<a class="reference internal" href="plugins-toolkit.html#ckan.plugins.toolkit.get_converter" title="ckan.plugins.toolkit.get_converter"><tt class="xref py py-func docutils literal"><span class="pre">get_converter()</span></tt></a> to get the
<a class="reference internal" href="converters.html#ckan.logic.converters.convert_user_name_or_id_to_id" title="ckan.logic.converters.convert_user_name_or_id_to_id"><tt class="xref py py-func docutils literal"><span class="pre">convert_user_name_or_id_to_id()</span></tt></a> converter
function, which it uses to convert the name of the logged-in user to their user
<tt class="docutils literal"><span class="pre">id</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre>    <span class="n">convert_user_name_or_id_to_id</span> <span class="o">=</span> <span class="n">toolkit</span><span class="o">.</span><span class="n">get_converter</span><span class="p">(</span>
        <span class="s">&#39;convert_user_name_or_id_to_id&#39;</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">convert_user_name_or_id_to_id</span><span class="p">(</span><span class="n">user_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, we can test whether the logged-in user is a member of the <tt class="docutils literal"><span class="pre">curators</span></tt>
group, and allow or refuse the action:</p>
<div class="highlight-python"><div class="highlight"><pre>    <span class="k">if</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="n">member_ids</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&#39;success&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&#39;success&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                <span class="s">&#39;msg&#39;</span><span class="p">:</span> <span class="s">&#39;Only curators are allowed to create groups&#39;</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="exception-handling">
<span id="id1"></span><h2>Exception handling<a class="headerlink" href="tutorial.html#exception-handling" title="Permalink to this headline">¶</a></h2>
<p>There are two bugs in our <tt class="docutils literal"><span class="pre">plugin.py</span></tt> file that need to be fixed using
exception handling. First, the class will crash if the site does not have a
group named <tt class="docutils literal"><span class="pre">curators</span></tt>.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">If you&#8217;ve already created a <tt class="docutils literal"><span class="pre">curators</span></tt> group and want to test what happens
when the site has no <tt class="docutils literal"><span class="pre">curators</span></tt> group, you can use CKAN&#8217;s command line
interface to <a class="reference internal" href="../paster.html#paster-db"><em>clean and reinitialize your database</em></a>.</p>
</div>
<p>Try visiting the <tt class="docutils literal"><span class="pre">/group</span></tt> page in CKAN with our <tt class="docutils literal"><span class="pre">example_iauthfunctions</span></tt>
plugin activated in your CKAN config file and with no <tt class="docutils literal"><span class="pre">curators</span></tt> group in
your site. If you have <tt class="docutils literal"><span class="pre">debug</span> <span class="pre">=</span> <span class="pre">false</span></tt> in your CKAN config file, you&#8217;ll see
something like this in your browser:</p>
<div class="highlight-python"><div class="highlight"><pre>Error 500

Server Error

An internal server error occurred
</pre></div>
</div>
<p>If you have <tt class="docutils literal"><span class="pre">debug</span> <span class="pre">=</span> <span class="pre">true</span></tt> in your CKAN config file, then you&#8217;ll see a
traceback page with details about the crash.</p>
<p>You&#8217;ll also get a <tt class="docutils literal"><span class="pre">500</span> <span class="pre">Server</span> <span class="pre">Error</span></tt> if you try to create a group using the
<tt class="docutils literal"><span class="pre">group_create</span></tt> API action.</p>
<p>To handle the situation where the site has no <tt class="docutils literal"><span class="pre">curators</span></tt> group without
crashing, we&#8217;ll have to handle the exception that CKAN&#8217;s
<a class="reference internal" href="../api.html#ckan.logic.action.get.member_list" title="ckan.logic.action.get.member_list"><tt class="xref py py-func docutils literal"><span class="pre">member_list()</span></tt></a> function raises when it&#8217;s asked to
list the members of a group that doesn&#8217;t exist. Replace the <tt class="docutils literal"><span class="pre">member_list</span></tt>
line in your <tt class="docutils literal"><span class="pre">plugin.py</span></tt> file with these lines:</p>
<div class="highlight-python"><div class="highlight"><pre>    <span class="k">try</span><span class="p">:</span>
        <span class="n">members</span> <span class="o">=</span> <span class="n">toolkit</span><span class="o">.</span><span class="n">get_action</span><span class="p">(</span><span class="s">&#39;member_list&#39;</span><span class="p">)(</span>
            <span class="n">data_dict</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="s">&#39;curators&#39;</span><span class="p">,</span> <span class="s">&#39;object_type&#39;</span><span class="p">:</span> <span class="s">&#39;user&#39;</span><span class="p">})</span>
    <span class="k">except</span> <span class="n">toolkit</span><span class="o">.</span><span class="n">ObjectNotFound</span><span class="p">:</span>
        <span class="c"># The curators group doesn&#39;t exist.</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&#39;success&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                <span class="s">&#39;msg&#39;</span><span class="p">:</span> <span class="s">&quot;The curators groups doesn&#39;t exist, so only sysadmins &quot;</span>
                       <span class="s">&quot;are authorized to create groups.&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>With these <tt class="docutils literal"><span class="pre">try</span></tt> and <tt class="docutils literal"><span class="pre">except</span></tt> clauses added, we should be able to load the
<tt class="docutils literal"><span class="pre">/group</span></tt> page and add groups, even if there isn&#8217;t already a group called
<tt class="docutils literal"><span class="pre">curators</span></tt>.</p>
<p>Second, <tt class="docutils literal"><span class="pre">plugin.py</span></tt> will crash if a user who is not logged-in tries to create
a group. If you logout of CKAN, and then visit <tt class="docutils literal"><span class="pre">/group/new</span></tt> you&#8217;ll see
another <tt class="docutils literal"><span class="pre">500</span> <span class="pre">Server</span> <span class="pre">Error</span></tt>. You&#8217;ll also get this error if you post to the
<a class="reference internal" href="../api.html#ckan.logic.action.create.group_create" title="ckan.logic.action.create.group_create"><tt class="xref py py-func docutils literal"><span class="pre">group_create()</span></tt></a> API action without
<a class="reference internal" href="../api.html#api-authentication"><em>providing an API key</em></a>.</p>
<p>When the user isn&#8217;t logged in, <tt class="docutils literal"><span class="pre">context['user']</span></tt> contains the user&#8217;s IP
address instead of a user name:</p>
<div class="highlight-python"><div class="highlight"><pre>{&#39;model&#39;: &lt;module &#39;ckan.model&#39; from ...&gt;,
 &#39;user&#39;: u&#39;127.0.0.1&#39;}
</pre></div>
</div>
<p>When we pass this IP address as the user name to
<a class="reference internal" href="converters.html#ckan.logic.converters.convert_user_name_or_id_to_id" title="ckan.logic.converters.convert_user_name_or_id_to_id"><tt class="xref py py-func docutils literal"><span class="pre">convert_user_name_or_id_to_id()</span></tt></a>, the converter
function will raise an exception because no user with that user name exists.
We need to handle that exception as well, replace the
<tt class="docutils literal"><span class="pre">convert_user_name_or_id_to_id</span></tt> line in your <tt class="docutils literal"><span class="pre">plugin.py</span></tt> file with these
lines:</p>
<div class="highlight-python"><div class="highlight"><pre>    <span class="n">convert_user_name_or_id_to_id</span> <span class="o">=</span> <span class="n">toolkit</span><span class="o">.</span><span class="n">get_converter</span><span class="p">(</span>
        <span class="s">&#39;convert_user_name_or_id_to_id&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">convert_user_name_or_id_to_id</span><span class="p">(</span><span class="n">user_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">toolkit</span><span class="o">.</span><span class="n">Invalid</span><span class="p">:</span>
        <span class="c"># The user doesn&#39;t exist (e.g. they&#39;re not logged-in).</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&#39;success&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                <span class="s">&#39;msg&#39;</span><span class="p">:</span> <span class="s">&#39;You must be logged-in as a member of the curators &#39;</span>
                       <span class="s">&#39;group to create new groups.&#39;</span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="we-re-done">
<h2>We&#8217;re done!<a class="headerlink" href="tutorial.html#we-re-done" title="Permalink to this headline">¶</a></h2>
<p>Here&#8217;s our final, working <tt class="docutils literal"><span class="pre">plugin.py</span></tt> module in full:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">ckan.plugins</span> <span class="kn">as</span> <span class="nn">plugins</span>
<span class="kn">import</span> <span class="nn">ckan.plugins.toolkit</span> <span class="kn">as</span> <span class="nn">toolkit</span>


<span class="k">def</span> <span class="nf">group_create</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">data_dict</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
<span class="c">#    from nose.tools import set_trace; set_trace()</span>
    <span class="c"># Get the user name of the logged-in user.</span>
    <span class="n">user_name</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s">&#39;user&#39;</span><span class="p">]</span>

    <span class="c"># Get a list of the members of the &#39;curators&#39; group.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">members</span> <span class="o">=</span> <span class="n">toolkit</span><span class="o">.</span><span class="n">get_action</span><span class="p">(</span><span class="s">&#39;member_list&#39;</span><span class="p">)(</span>
            <span class="n">data_dict</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="s">&#39;curators&#39;</span><span class="p">,</span> <span class="s">&#39;object_type&#39;</span><span class="p">:</span> <span class="s">&#39;user&#39;</span><span class="p">})</span>
    <span class="k">except</span> <span class="n">toolkit</span><span class="o">.</span><span class="n">ObjectNotFound</span><span class="p">:</span>
        <span class="c"># The curators group doesn&#39;t exist.</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&#39;success&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                <span class="s">&#39;msg&#39;</span><span class="p">:</span> <span class="s">&quot;The curators groups doesn&#39;t exist, so only sysadmins &quot;</span>
                       <span class="s">&quot;are authorized to create groups.&quot;</span><span class="p">}</span>

    <span class="c"># &#39;members&#39; is a list of (user_id, object_type, capacity) tuples, we&#39;re</span>
    <span class="c"># only interested in the user_ids.</span>
    <span class="n">member_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">member_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">member_tuple</span> <span class="ow">in</span> <span class="n">members</span><span class="p">]</span>

    <span class="c"># We have the logged-in user&#39;s user name, get their user id.</span>
    <span class="n">convert_user_name_or_id_to_id</span> <span class="o">=</span> <span class="n">toolkit</span><span class="o">.</span><span class="n">get_converter</span><span class="p">(</span>
        <span class="s">&#39;convert_user_name_or_id_to_id&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">convert_user_name_or_id_to_id</span><span class="p">(</span><span class="n">user_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">toolkit</span><span class="o">.</span><span class="n">Invalid</span><span class="p">:</span>
        <span class="c"># The user doesn&#39;t exist (e.g. they&#39;re not logged-in).</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&#39;success&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                <span class="s">&#39;msg&#39;</span><span class="p">:</span> <span class="s">&#39;You must be logged-in as a member of the curators &#39;</span>
                       <span class="s">&#39;group to create new groups.&#39;</span><span class="p">}</span>

    <span class="c"># Finally, we can test whether the user is a member of the curators group.</span>
    <span class="k">if</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="n">member_ids</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&#39;success&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&#39;success&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                <span class="s">&#39;msg&#39;</span><span class="p">:</span> <span class="s">&#39;Only curators are allowed to create groups&#39;</span><span class="p">}</span>


<span class="k">class</span> <span class="nc">ExampleIAuthFunctionsPlugin</span><span class="p">(</span><span class="n">plugins</span><span class="o">.</span><span class="n">SingletonPlugin</span><span class="p">):</span>
    <span class="n">plugins</span><span class="o">.</span><span class="n">implements</span><span class="p">(</span><span class="n">plugins</span><span class="o">.</span><span class="n">IAuthFunctions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_auth_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&#39;group_create&#39;</span><span class="p">:</span> <span class="n">group_create</span><span class="p">}</span>
</pre></div>
</div>
<p>In working through this tutorial, you&#8217;ve covered all the key concepts needed
for writing CKAN extensions, including:</p>
<ul class="simple">
<li>Creating an extension</li>
<li>Creating a plugin within your extension</li>
<li>Adding your plugin to your extension&#8217;s <tt class="docutils literal"><span class="pre">setup.py</span></tt> file,
and installing your extension</li>
<li>Making your plugin implement one of CKAN&#8217;s
<a class="reference internal" href="plugin-interfaces.html"><em>plugin interfaces</em></a></li>
<li>Using the <a class="reference internal" href="plugins-toolkit.html"><em>plugins toolkit</em></a></li>
<li>Handling exceptions</li>
</ul>
</div>
<div class="section" id="id2">
<h2>Troubleshooting<a class="headerlink" href="tutorial.html#id2" title="Permalink to this headline">¶</a></h2>
<div class="section" id="attributeerror">
<h3><tt class="docutils literal"><span class="pre">AttributeError</span></tt><a class="headerlink" href="tutorial.html#attributeerror" title="Permalink to this headline">¶</a></h3>
<p>If you get an <tt class="docutils literal"><span class="pre">AttributeError</span></tt> like this one:</p>
<div class="highlight-python"><div class="highlight"><pre>AttributeError: &#39;ExampleIAuthFunctionsPlugin&#39; object has no attribute &#39;get_auth_functions&#39;
</pre></div>
</div>
<p>it means that your plugin class does not implement one of the plugin
interface&#8217;s methods. A plugin must implement every method of every plugin
interface that it implements.</p>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p class="last">Can you user inherit=True to avoid having to implement them all?</p>
</div>
<p>Other <tt class="docutils literal"><span class="pre">AttributeError</span></tt>s can happen if your method returns the wrong type of
value, check the documentation for each plugin interface method to see what
your method should return.</p>
</div>
<div class="section" id="typeerror">
<h3><tt class="docutils literal"><span class="pre">TypeError</span></tt><a class="headerlink" href="tutorial.html#typeerror" title="Permalink to this headline">¶</a></h3>
<p>If you get a <tt class="docutils literal"><span class="pre">TypeError</span></tt> like this one:</p>
<div class="highlight-python"><div class="highlight"><pre>TypeError: get_auth_functions() takes exactly 3 arguments (1 given)
</pre></div>
</div>
<p>it means that one of your plugin methods has the wrong number of parameters.
A plugin has to implement each method in a plugin interface with the same
parameters as in the interface.</p>
</div>
</div>
</div>



        
        <div style="font-size:smaller;">
          <hr/>
          
            
          
            
          
            
              <div class="pull-right">
                <a href="testing-extensions.html"
                  title="Testing extensions" accesskey="N">
                    
                      
                    
                    Testing extensions→
                </a>
              </div>
            
          
            
              <div >
                <a href="index.html"
                  title="Writing CKAN extensions" accesskey="P">
                    
                      
                    
                    ← Writing CKAN extensions
                </a>
              </div>
            
          
          <div style="clear:both;"></div>
        </div>

      </div>
    </div>
  </div> <!-- / row -->
</div>

<footer>
  <div class="inner">
    <div class="container-fluid">
      <p>An <a href="http://okfn.org">Open Knowledge Foundation</a> project.</p>

<p class="copyright">
  &copy; 2009-2013, <a href="http://okfn.org/">Open Knowledge Foundation</a>.
    Licensed under <a
    href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons
    Attribution ShareAlike (Unported) v3.0 License</a>.<br />
    <img src="http://i.creativecommons.org/l/by-sa/3.0/80x15.png" alt="CC License Logo" />
    <a href="http://opendefinition.org/"><img src="http://assets.okfn.org/images/ok_buttons/oc_80x15_blue.png" border="0"
      alt="{{ _('Open Content') }}" /></a>
  <br/>
</p>

<p>
<a href="https://github.com/ckan/ckan">Source</a>
&mdash;
<a href="https://github.com/ckan/ckan/issues">Issues</a>
&mdash;
<a href="http://lists.okfn.org/mailman/listinfo/ckan-dev">Mailing List</a>
&mdash;
<a href="http://twitter.com/CKANProject">Twitter @CKANProject</a>
</p>

<p>
Related Projects:
<a href="http://thedatahub.org/">The DataHub</a>
&mdash;
<a href="http://datacatalogs.org">DataCatalogs.org</a>
&mdash;
<a href="http://openspending.org">OpenSpending.org</a>
&mdash;
<a href="http://opendatahandbook.org">Open Data Handbook</a>
</p>

    </div>
  </div>
</footer>



  </body>
</html>